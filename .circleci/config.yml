version: 2.1

jobs:
  build-and-test:
    docker:
      - image: circleci/node:12.16.3]
    working_directory: ~/cricketgate
    steps:
      - restore_cache:
          keys:
            - node-v1-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - node-v1-{{ .Branch }}-
            - node-v1-
      - checkout
      - run:
          name: npm install
          command: npm install
      - run:
          name: npm install for functions
          command: |
            cd functions
            npm install
      - run:
          name: build
          command: npm run test:unit
      - save_cache:
          paths:
            - ~/usr/local/lib/node_modules
          key: node-v1-{{ .Branch }}-{{ checksum "package-lock.json" }}
      - store_artifacts:
          path: /tmp/artifacts
          destination: build

  deploy:
    docker:
      - image: circleci/node:12.16.3
    working_directory: ~/cricketgate
    steps:
      - restore_cache:
          keys:
            - node-v1-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - node-v1-{{ .Branch }}-
            - node-v1-
      - checkout
      - run:
          name: install firebase-tools
          command: sudo npm install firebase-tools -g
      - run:
          name: deploy to Firebase Hosting
          command: firebase deploy --token=$FIREBASE_TOKEN

workflows:
  version: 2
  build-test-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
